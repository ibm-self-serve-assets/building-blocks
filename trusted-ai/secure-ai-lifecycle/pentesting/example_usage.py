"""
Example usage of the LLM Penetration Testing Client.

This script demonstrates the complete workflow for conducting penetration tests
on LLM endpoints using the client library.
"""

import os
from datetime import datetime, timedelta
from llm_pentest_client import LLMPentestClient


def main():
    """Main example demonstrating the full workflow."""

    print("=" * 70)
    print("LLM Penetration Testing Client - Example Usage")
    print("=" * 70)

    # Step 1: Initialize the client
    print("\n1. Initializing client...")
    print("-" * 70)

    # Option 1: Use environment variables
    # export API_URL=https://api.example.com
    # export API_KEY=your-api-key
    # export CUSTOMER_ID=your-customer-id
    # export OPENAI_API_KEY=sk-...

    # Option 2: Pass credentials directly
    client = LLMPentestClient(
        api_url=os.environ.get("API_URL"),
        api_key=os.environ.get("API_KEY"),
        customer_id=os.environ.get("CUSTOMER_ID")
    )

    # Verify connection
    try:
        response = client.verify_connection()
        print(f"✓ Connected successfully!")
        print(f"  Token expires: {response.get('expires_at', 'N/A')}")
    except Exception as e:
        print(f"✗ Connection failed: {e}")
        return

    # Step 2: Create or select an endpoint
    print("\n2. Managing LLM Endpoints...")
    print("-" * 70)

    # List existing endpoints
    endpoints = client.endpoints.list()
    print(f"Found {len(endpoints.get('resources', []))} existing endpoints:")
    for ep in endpoints.get('resources', [])[:3]:
        print(f"  - {ep['resource_display_name']}")

    # Create a new OpenAI endpoint
    openai_api_key = os.environ.get("OPENAI_API_KEY")
    if openai_api_key:
        print("\nCreating new OpenAI endpoint...")
        endpoint = client.endpoints.create_openai(
            api_key=openai_api_key,
            identifier=f"example-endpoint-{datetime.now().strftime('%Y%m%d-%H%M%S')}",
            display_name="Example GPT-4 Endpoint",
            pentest_model="gpt-4o"
        )
        resource_id = endpoint['added_resources'][0]['resource_instance_id']
        print(f"✓ Endpoint created: {resource_id}")
    else:
        print("Skipping endpoint creation (OPENAI_API_KEY not set)")
        # Use an existing endpoint for demonstration
        if endpoints.get('resources'):
            resource_id = endpoints['resources'][0]['resource_instance_id']
            print(f"Using existing endpoint: {resource_id}")
        else:
            print("No endpoints available. Please create one first.")
            return

    # Step 3: Create or select a template
    print("\n3. Managing Templates...")
    print("-" * 70)

    # List available categories
    categories = client.templates.list_categories()
    print(f"Available test categories: {len(categories.get('llm_pentest_categories', []))}")
    print("First 5 categories:")
    for cat in categories.get('llm_pentest_categories', [])[:5]:
        print(f"  - {cat['id']}: {cat.get('name', 'N/A')}")

    # Create a new template
    print("\nCreating new template...")
    template = client.templates.create(
        name=f"Example Template {datetime.now().strftime('%Y%m%d-%H%M%S')}",
        category_ids=[
            "input_denial_of_wallet_attack",
            "renellm"
        ],
        description="Example security assessment template"
    )
    template_id = template['id']
    print(f"✓ Template created: {template_id}")

    # List all templates
    templates = client.templates.list()
    print(f"\nTotal templates: {len(templates.get('llm_pentest_scan_templates', []))}")

    # Step 4: Run a one-time penetration test
    print("\n4. Running One-Time Penetration Test...")
    print("-" * 70)

    result = client.tests.start_one_time(
        resource_instance_id=resource_id,
        scan_template_id=template_id,
        description="Example security test"
    )

    execution_id = result['llm_pentest_scan_execution_id']
    print(f"✓ Test started: {execution_id}")

    # Check initial status
    status = client.tests.get_status(execution_id)
    print(f"  Initial status: {status['status']}")

    # Wait for completion (with short timeout for demonstration)
    print("\nWaiting for test to complete...")
    print("(This may take several minutes...)")

    try:
        final_status = client.tests.wait_for_completion(
            execution_id,
            poll_interval=30,
            timeout=1800  # 30 minutes
        )
        print(f"✓ Test completed with status: {final_status['status']}")

        # Step 5: Generate and download report
        if final_status['status'] == 'COMPLETED':
            print("\n5. Generating Report...")
            print("-" * 70)

            report_path = f"pentest_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
            downloaded_path = client.reports.generate_and_download(
                execution_ids=[execution_id],
                output_path=report_path
            )
            print(f"✓ Report downloaded: {downloaded_path}")
        else:
            print(f"\n✗ Test did not complete successfully: {final_status['status']}")

    except TimeoutError:
        print("✗ Test did not complete within timeout period")
        print("  You can check status later using:")
        print(f"    status = client.tests.get_status('{execution_id}')")

    # Step 6: Create a scheduled test (optional)
    print("\n6. Creating Scheduled Test (Optional)...")
    print("-" * 70)

    scheduled = client.tests.create_scheduled(
        resource_instance_id=resource_id,
        scan_template_id=template_id,
        cron_expression="0 2 * * ? *",  # Daily at 2 AM UTC
        description="Daily security scan",
        start_at=datetime.now().isoformat(),
        end_at=(datetime.now() + timedelta(days=7)).isoformat()
    )

    print(f"✓ Scheduled test created:")
    print(f"  Job ID: {scheduled['job']['job_id']}")
    print(f"  Schedule ID: {scheduled['schedule']['id']}")
    print(f"  Frequency: Daily at 2:00 AM UTC")
    print(f"  Duration: 7 days")

    print("\n" + "=" * 70)
    print("Example completed successfully!")
    print("=" * 70)


def example_custom_endpoint():
    """Example of creating a custom REST API endpoint."""

    print("\nCustom Endpoint Example")
    print("-" * 70)

    client = LLMPentestClient()

    # Create a custom endpoint for a non-OpenAI API
    custom_endpoint = client.endpoints.create_custom(
        identifier="custom-llm-example",
        pentest_url="https://api.example.com/v1/chat/completions",
        headers={
            "Authorization": "Bearer your-api-token",
            "Content-Type": "application/json"
        },
        body={
            "model": "custom-model-v1",
            "messages": [
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": "<<PROMPT>>"}
            ],
            "temperature": 0.7
        },
        response_jsonpaths=["$.choices[0].message.content"],
        response_type="json",
        display_name="Custom LLM API"
    )

    print(f"✓ Custom endpoint created: {custom_endpoint['added_resources'][0]['resource_instance_id']}")


def example_advanced_features():
    """Example of advanced features."""

    print("\nAdvanced Features Example")
    print("-" * 70)

    client = LLMPentestClient()

    # Get endpoint by name
    endpoint = client.endpoints.get_by_name("Example GPT-4 Endpoint")
    if endpoint:
        print(f"✓ Found endpoint: {endpoint['resource_instance_id']}")

    # Get template by name
    template = client.templates.get_by_name("Comprehensive Security Scan")
    if template:
        print(f"✓ Found template: {template['id']}")
        print(f"  Categories: {len(template.get('categories', []))}")

    # Override connection details for a specific test
    if endpoint and template:
        result = client.tests.start_one_time(
            resource_instance_id=endpoint['resource_instance_id'],
            scan_template_id=template['id'],
            pentest_connection_details={
                "pentest_url": "https://staging-api.openai.com/v1",
                "pentest_api_key": "different-key",
                "model": "gpt-4"
            }
        )
        print(f"✓ Test started with custom connection: {result['llm_pentest_scan_execution_id']}")


if __name__ == "__main__":
    # Run main example
    main()

    # Uncomment to run additional examples:
    # example_custom_endpoint()
    # example_advanced_features()
