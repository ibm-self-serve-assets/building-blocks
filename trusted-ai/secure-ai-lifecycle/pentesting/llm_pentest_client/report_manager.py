"""
Report generation and download for LLM Penetration Testing.

Handles generating and downloading PDF reports for completed test executions.
"""

from typing import Dict, Any, List, TYPE_CHECKING
import requests

if TYPE_CHECKING:
    from .client import LLMPentestClient


class ReportManager:
    """
    Manages pentest report generation and download.

    Generates PDF reports for completed test executions and provides
    pre-signed URLs for downloading.
    """

    def __init__(self, client: "LLMPentestClient"):
        """
        Initialize the report manager.

        Args:
            client: Parent LLMPentestClient instance.
        """
        self.client = client

    def generate(self, execution_ids: List[str]) -> Dict[str, Any]:
        """
        Generate a report for completed test executions.

        Can generate a single report combining results from multiple executions.

        Args:
            execution_ids: List of execution IDs to include in the report.

        Returns:
            Report details including:
            - report_url: Pre-signed URL to download the report (valid for 1 hour)

        Example:
            report = client.reports.generate(["execution-123", "execution-456"])
            download_url = report['report_url']
            print(f"Report ready: {download_url}")

        Note:
            The download URL is typically valid for 1 hour after generation.
        """
        data = {"llm_pentest_scan_execution_ids": execution_ids}
        endpoint = (
            f"/v1/llm-pentest/customers/{self.client.customer_id}"
            "/executions/generate-report"
        )
        return self.client.make_request(endpoint, method="POST", data=data)

    def download(self, report_url: str, output_path: str) -> None:
        """
        Download a report from a pre-signed URL.

        Args:
            report_url: Pre-signed URL from generate() method.
            output_path: Local file path to save the report (e.g., "report.pdf").

        Raises:
            requests.exceptions.RequestException: If download fails.

        Example:
            report = client.reports.generate(["execution-123"])
            client.reports.download(
                report_url=report['report_url'],
                output_path="/path/to/security_report.pdf"
            )
            print("Report downloaded successfully!")
        """
        response = requests.get(report_url)
        response.raise_for_status()

        with open(output_path, "wb") as f:
            f.write(response.content)

    def generate_and_download(
        self,
        execution_ids: List[str],
        output_path: str = "llm_pentest_report.pdf"
    ) -> str:
        """
        Generate and download a report in one call.

        Convenience method that combines generate() and download().

        Args:
            execution_ids: List of execution IDs to include in report.
            output_path: Local file path to save the report
                (default: "llm_pentest_report.pdf").

        Returns:
            Path to the downloaded report file.

        Example:
            # Run a test
            result = client.tests.start_one_time(...)
            execution_id = result['llm_pentest_scan_execution_id']

            # Wait for completion
            final_status = client.tests.wait_for_completion(execution_id)

            # Generate and download report
            if final_status['status'] == 'COMPLETED':
                report_path = client.reports.generate_and_download(
                    execution_ids=[execution_id],
                    output_path="security_scan_2024.pdf"
                )
                print(f"Report saved to: {report_path}")
        """
        report = self.generate(execution_ids)
        self.download(report["report_url"], output_path)
        return output_path
