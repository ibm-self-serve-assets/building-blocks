"""
Template management for LLM Penetration Testing.

Handles pentest categories and templates (predefined sets of test categories).
"""

from typing import Dict, Any, List, Optional, TYPE_CHECKING

if TYPE_CHECKING:
    from .client import LLMPentestClient


class TemplateManager:
    """
    Manages pentest templates and categories.

    Templates are predefined sets of test categories used to conduct penetration tests.
    They ensure consistency and allow reuse across multiple endpoints.
    """

    def __init__(self, client: "LLMPentestClient"):
        """
        Initialize the template manager.

        Args:
            client: Parent LLMPentestClient instance.
        """
        self.client = client

    def list_categories(self) -> Dict[str, Any]:
        """
        List all available pentest categories.

        Categories are the individual types of security tests that can be run
        (e.g., "input_denial_of_wallet_attack", "renellm", etc.).

        Returns:
            Dictionary containing list of pentest categories in
            'llm_pentest_categories' key.

        Example:
            result = client.templates.list_categories()
            for category in result['llm_pentest_categories']:
                print(f"{category['id']}: {category['name']}")
        """
        return self.client.make_request("/v1/llm-pentest/categories")

    def create(
        self,
        name: str,
        category_ids: List[str],
        description: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Create a pentest template with specified categories.

        Templates group multiple test categories together for reuse across
        different endpoints.

        Args:
            name: Human-readable name for the template.
            category_ids: List of pentest category IDs to include in the template.
            description: Optional description of the template.

        Returns:
            Created template details including template ID.

        Example:
            template = client.templates.create(
                name="Comprehensive Security Scan",
                category_ids=[
                    "input_denial_of_wallet_attack",
                    "renellm",
                    "prompt_injection"
                ],
                description="Full security assessment for production endpoints"
            )
            template_id = template['id']
        """
        data = {
            "name": name,
            "pentest_category_ids": category_ids,
            "customer_id": self.client.customer_id
        }

        if description:
            data["description"] = description

        return self.client.make_request(
            "/v1/llm-pentest/scan_templates",
            method="POST",
            data=data
        )

    def list(self) -> Dict[str, Any]:
        """
        List all pentest templates for the customer.

        Returns:
            Dictionary containing list of templates in
            'llm_pentest_scan_templates' key.

        Example:
            result = client.templates.list()
            for template in result['llm_pentest_scan_templates']:
                print(f"{template['name']} - {len(template['categories'])} categories")
        """
        endpoint = f"/v1/llm-pentest/scan_templates?customer_id={self.client.customer_id}"
        return self.client.make_request(endpoint)

    def get_by_name(self, name: str) -> Optional[Dict[str, Any]]:
        """
        Get a template by its name.

        Args:
            name: Name of the template.

        Returns:
            Template details if found, None otherwise.

        Example:
            template = client.templates.get_by_name("Comprehensive Security Scan")
            if template:
                print(f"Found template ID: {template['id']}")
        """
        templates = self.list()
        for template in templates.get("llm_pentest_scan_templates", []):
            if template.get("name") == name:
                return template
        return None
