# LLM Penetration Testing Client

A Python client library for conducting penetration tests on LLM endpoints. This library provides a clean, modular interface for managing endpoints, templates, test execution, and report generation.

## What's in This Directory

This directory contains both educational material and production-ready code for LLM penetration testing:

### Files and Folders

- **`llm_pentest_client/`** - Production-ready Python package for integrating pentesting capabilities into your applications. This is a modular, reusable library extracted from the notebook.
  - `client.py` - Core client with JWT authentication
  - `endpoint_manager.py` - Manage LLM endpoints (OpenAI, custom APIs)
  - `template_manager.py` - Manage test templates and categories
  - `test_manager.py` - Execute one-time and scheduled tests
  - `report_manager.py` - Generate and download PDF reports

- **`example_usage.py`** - Complete working examples showing how to use the client library in your code

- **`setup.py`** - Package configuration for installing as a Python package

- **`requirements.txt`** - Python dependencies

- **`Pentesting.ipynb`** - Interactive Jupyter notebook that serves as a tutorial and regression test for the pentesting API. Great for learning the API workflow step-by-step with detailed explanations.

### Which Should I Use?

- **Learning & Exploration**: Start with `Pentesting.ipynb` to understand the API interactively
- **Production Integration**: Use the `llm_pentest_client` package in your applications
- **Quick Reference**: Check `example_usage.py` for code snippets

## Features

- **Authentication Management**: JWT token-based authentication
- **Endpoint Management**: Support for OpenAI-compatible and custom REST API endpoints
- **Template Management**: Create and manage reusable test templates
- **Test Execution**: Run one-time or scheduled penetration tests
- **Report Generation**: Generate and download comprehensive PDF reports

## Installation

### From Source

```bash
# Clone or copy the llm_pentest_client directory to your project
cd /path/to/your/project
cp -r /path/to/llm_pentest_client .

# Install dependencies
pip install requests
```

### As a Package

```bash
# From the directory containing llm_pentest_client
pip install -e .
```

## Quick Start

### 1. Initialize the Client

```python
from llm_pentest_client import LLMPentestClient

# Option 1: Pass credentials directly
client = LLMPentestClient(
    api_url="https://api.example.com",
    api_key="your-api-key",
    customer_id="your-customer-id"
)

# Option 2: Use environment variables
# export API_URL=https://api.example.com
# export API_KEY=your-api-key
# export CUSTOMER_ID=your-customer-id
client = LLMPentestClient()

# Verify connection
response = client.verify_connection()
print(f"Connected! Token expires: {response.get('expires_at')}")
```

### 2. Create an LLM Endpoint

```python
# Create an OpenAI-compatible endpoint
endpoint = client.endpoints.create_openai(
    api_key="sk-...",
    identifier="my-gpt4-endpoint",
    display_name="GPT-4 Production",
    pentest_model="gpt-4o"
)

resource_id = endpoint['added_resources'][0]['resource_instance_id']
print(f"Endpoint created: {resource_id}")

# Or create a custom REST API endpoint
custom_endpoint = client.endpoints.create_custom(
    identifier="custom-llm",
    pentest_url="https://api.example.com/v1/generate",
    headers={"Authorization": "Bearer token123"},
    body={
        "model": "llama-2-70b",
        "prompt": "<<PROMPT>>",
        "max_tokens": 100
    },
    response_jsonpaths=["$.output.text"],
    response_type="json"
)
```

### 3. Create a Test Template

```python
# List available categories
categories = client.templates.list_categories()
for cat in categories['llm_pentest_categories'][:5]:
    print(f"{cat['id']}: {cat['name']}")

# Create a template
template = client.templates.create(
    name="Comprehensive Security Scan",
    category_ids=[
        "input_denial_of_wallet_attack",
        "renellm",
        "prompt_injection"
    ],
    description="Full security assessment"
)

template_id = template['id']
print(f"Template created: {template_id}")
```

### 4. Run a Penetration Test

```python
# Start a one-time test
result = client.tests.start_one_time(
    resource_instance_id=resource_id,
    scan_template_id=template_id,
    description="Weekly security check"
)

execution_id = result['llm_pentest_scan_execution_id']
print(f"Test started: {execution_id}")

# Check status
status = client.tests.get_status(execution_id)
print(f"Status: {status['status']}")

# Wait for completion
final_status = client.tests.wait_for_completion(
    execution_id,
    poll_interval=60,
    timeout=3600
)

if final_status['status'] == 'COMPLETED':
    print("Test completed successfully!")
```

### 5. Generate and Download Report

```python
# Generate and download report
report_path = client.reports.generate_and_download(
    execution_ids=[execution_id],
    output_path="security_report.pdf"
)

print(f"Report saved to: {report_path}")
```

## Advanced Usage

### Scheduled Tests

```python
from datetime import datetime, timedelta

# Create a scheduled test (daily at 2 AM UTC)
result = client.tests.create_scheduled(
    resource_instance_id=resource_id,
    scan_template_id=template_id,
    cron_expression="0 2 * * ? *",
    description="Daily production security scan",
    end_at=(datetime.now() + timedelta(days=90)).isoformat()
)

print(f"Job ID: {result['job']['job_id']}")
print(f"Schedule ID: {result['schedule']['id']}")
```

### Managing Endpoints

```python
# List all endpoints
endpoints = client.endpoints.list()
for ep in endpoints['resources']:
    print(f"{ep['resource_display_name']}: {ep['resource_instance_id']}")

# Get endpoint by name
endpoint = client.endpoints.get_by_name("GPT-4 Production")
if endpoint:
    print(f"Found: {endpoint['resource_instance_id']}")
```

### Managing Templates

```python
# List all templates
templates = client.templates.list()
for tmpl in templates['llm_pentest_scan_templates']:
    print(f"{tmpl['name']}: {len(tmpl['categories'])} categories")

# Get template by name
template = client.templates.get_by_name("Comprehensive Security Scan")
if template:
    print(f"Template ID: {template['id']}")
```

### Custom Connection Details for Tests

```python
# Override endpoint connection details for a specific test
result = client.tests.start_one_time(
    resource_instance_id=resource_id,
    scan_template_id=template_id,
    pentest_connection_details={
        "pentest_url": "https://staging-api.example.com/v1",
        "pentest_api_key": "different-key",
        "model": "gpt-4"
    }
)
```

## Directory Structure

```
pentesting/
├── Pentesting.ipynb         # Interactive tutorial notebook
├── llm_pentest_client/      # Python package
│   ├── __init__.py          # Package initialization and exports
│   ├── client.py            # Core client with authentication
│   ├── endpoint_manager.py  # Endpoint creation and management
│   ├── template_manager.py  # Template and category management
│   ├── test_manager.py      # Test execution and scheduling
│   └── report_manager.py    # Report generation and download
├── example_usage.py         # Usage examples
├── setup.py                 # Package installation config
├── requirements.txt         # Python dependencies
├── .gitignore              # Git ignore rules
└── README.md               # This file
```

## API Reference

### LLMPentestClient

Main client class that provides access to all managers.

**Properties:**
- `endpoints`: EndpointManager instance
- `templates`: TemplateManager instance
- `tests`: TestManager instance
- `reports`: ReportManager instance

**Methods:**
- `verify_connection()`: Verify API connection

### EndpointManager

Manages LLM endpoints.

**Methods:**
- `create_openai(...)`: Create OpenAI-compatible endpoint
- `create_custom(...)`: Create custom REST API endpoint
- `list()`: List all endpoints
- `get_by_name(name)`: Get endpoint by display name

### TemplateManager

Manages pentest templates and categories.

**Methods:**
- `list_categories()`: List available test categories
- `create(name, category_ids)`: Create a template
- `list()`: List all templates
- `get_by_name(name)`: Get template by name

### TestManager

Manages test execution and scheduling.

**Methods:**
- `start_one_time(...)`: Start a one-time test
- `get_status(execution_id)`: Get execution status
- `wait_for_completion(execution_id)`: Wait for test to complete
- `create_job(...)`: Create a scheduled job
- `add_schedule(job_id, cron_expression)`: Add schedule to job
- `create_scheduled(...)`: Create job and schedule in one call

### ReportManager

Manages report generation and download.

**Methods:**
- `generate(execution_ids)`: Generate report
- `download(report_url, output_path)`: Download report
- `generate_and_download(execution_ids, output_path)`: Generate and download in one call

## Error Handling

```python
import requests

try:
    client = LLMPentestClient()
    result = client.tests.start_one_time(...)
except ValueError as e:
    print(f"Configuration error: {e}")
except ConnectionError as e:
    print(f"Authentication failed: {e}")
except requests.exceptions.RequestException as e:
    print(f"API request failed: {e}")
except TimeoutError as e:
    print(f"Test execution timeout: {e}")
```

## Environment Variables

The client supports the following environment variables:

- `API_URL`: Base URL for the API
- `API_KEY`: API key for authentication
- `CUSTOMER_ID`: Customer ID
- `OPENAI_API_KEY`: OpenAI API key (for creating OpenAI endpoints)

## Examples

See `example_usage.py` for a complete working example.

## License

Internal use only.

## Support

For issues or questions, contact the security team.
